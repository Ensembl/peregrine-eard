>> test

Basic include/macro smoke test

>> input

let x = 1;
include "include-macro-smoke2.earp";

>> input include-macro-smoke2.earp

let y = 2;
include "include-macro-smoke3.earp";

>> input include-macro-smoke3.earp

let z = 3;

>> preproc strip

[
    PTStatement{
        value: LetStatement([Normal((Variable{prefix:None,name:"x"},[]))],[Normal(Constant(Number(1.0)))]),
        file: ["test"],
        line_no: 2,
        context: 1
    },
    PTStatement{
        value: LetStatement([Normal((Variable{prefix:None,name:"y"},[]))],[Normal(Constant(Number(2.0)))]),
        file: ["test","include-macro-smoke2.earp"],
        line_no: 2,
        context: 2
    },
    PTStatement{
        value: LetStatement([Normal((Variable{prefix:None,name:"z"},[]))],[Normal(Constant(Number(3.0)))]),
        file: ["test","include-macro-smoke2.earp","include-macro-smoke3.earp"],
        line_no: 2,
        context: 3
    }
]

>> test

Missing include

>> input

include "missing";

>> preproc-fail strip

Error loading 'missing': Not found at test:2

>> test

Recursive include

>> input

include "test1";

>> input test1

include "test2";

>> input test2

include "test1";

>> preproc-fail strip

recursive include of test1 at test2:2

>> test

Non-recursive include

>> input

include "test1";

>> input test1

include "test2";
include "test2";

>> input test2

let x = 1;

>> preproc strip

[
    PTStatement {
        value: LetStatement([Normal((Variable{prefix:None,name:"x"},[]))],[Normal(Constant(Number(1.0)))]),
        file: ["test","test1","test2"],
        line_no: 2,
        context: 3
    },
    PTStatement{
        value: LetStatement([Normal((Variable{prefix:None,name:"x"},[]))],[Normal(Constant(Number(1.0)))]),
        file: ["test","test1","test2"],
        line_no: 2,
        context: 4
    }
]

>> test

Self-recursive include

>> input

include "test1";

>> input test1

include "test1";

>> preproc-fail strip

recursive include of test1 at test1:2

>> test

Proc macros

>> input

x!(2);

>> preproc strip

[
    PTStatement{
        value: LetStatement([Normal((Variable{prefix:None,name:"x"},[]))],[Normal(Constant(Number(2.0)))]),
        file: ["test"],
        line_no: 2,
        context: 1
    }
]

>> test

Expr macros

>> input

let x = 4 * y!(z);

>> preproc strip

[
    PTStatement{
        value: LetStatement(
            [Normal((Variable{prefix:None,name:"x"},[]))],
            [Normal(Call(PTCall{
                name: "__operator_mul",
                args:[
                    Normal(Constant(Number(4.0))),
                    Normal(Call(PTCall{
                        name: "__operator_add",
                        args: [
                            Normal(Variable(Variable{prefix:None,name:"z"})),
                            Normal(Constant(Number(1.0)))
                        ],
                        is_macro:false
                    }))
                ],
                is_macro: false
            }))]
        ),
        file: ["test"], 
        line_no: 2,
        context: 1
    }
]

>> test

multi loop

>> input

include "test1";

>> input test1

z!();

>> input test2

include "test3";

>> input test3

let x = 1;

>> preproc strip

[
    PTStatement{
        value: LetStatement([Normal((Variable{prefix:None,name:"x"},[]))],[Normal(Constant(Number(1.0)))]),
        file: ["test","test1","test2","test3"],
        line_no: 2,
        context: 4
    }
]

>> test

flags

>> input

flag "abc";
flag "def";
include "test2";

>> input test2

flag "ghi";

>> flag

abc
def
ghi

>> test

good repeater

>> input

let **tr_gn = lookup(**gn,tr.gn);

>> preproc strip

[
    PTStatement{
        value: LetStatement(
            [Repeater("tr_gn")],
            [Normal(Call(PTCall{
                name: "lookup",
                args: [
                    Repeater("gn"),
                    Normal(Variable(Variable{prefix:Some("tr"),name:"gn"}))
                ],
                is_macro: false
            }))]
        ),
        file: ["test"],
        line_no: 2,
        context: 1
    }
]

>> test

Operators to functions

>> input

let x = 1 || 2 && 3 == 4 > 5 + 6 * 7 / 8 - 9 < 10 != 11 && 12 || 13;

>> preproc strip

[
    PTStatement{
        value: LetStatement([Normal((Variable{prefix:None,name:"x"},[]))],
        [Normal(Call(PTCall{
            name: "__operator_or",
            args:[
                Normal(Call(PTCall{
                    name: "__operator_or",
                    args:[
                        Normal(Constant(Number(1.0))),
                        Normal(Call(PTCall{
                            name: "__operator_and",
                            args:[
                                Normal(Call(PTCall{
                                    name: "__operator_and",
                                    args:[
                                        Normal(Constant(Number(2.0))),
                                        Normal(Call(PTCall{
                                            name: "__operator_ne",
                                            args:[
                                                Normal(Call(PTCall{
                                                    name: "__operator_eq",
                                                    args:[
                                                        Normal(Constant(Number(3.0))),
                                                        Normal(Call(PTCall{
                                                            name: "__operator_lt",
                                                            args:[
                                                                Normal(Call(PTCall{
                                                                    name: "__operator_gt",
                                                                    args:[
                                                                        Normal(Constant(Number(4.0))),
                                                                        Normal(Call(PTCall{
                                                                            name: "__operator_sub",
                                                                            args:[
                                                                                Normal(Call(PTCall{
                                                                                    name: "__operator_add",args:[
                                                                                        Normal(Constant(Number(5.0))),
                                                                                        Normal(Call(PTCall{
                                                                                            name: "__operator_div ",
                                                                                            args:[
                                                                                                Normal(Call(PTCall{
                                                                                                    name: "__operator_mul",
                                                                                                    args:[
                                                                                                        Normal(Constant(Number(6.0))),
                                                                                                        Normal(Constant(Number(7.0)))
                                                                                                    ],
                                                                                                    is_macro:false
                                                                                                })),
                                                                                                Normal(Constant(Number(8.0)))
                                                                                            ],
                                                                                            is_macro: false
                                                                                        }))],
                                                                                        is_macro: false
                                                                                    })),
                                                                                    Normal(Constant(Number(9.0)))
                                                                                ],
                                                                                is_macro: false
                                                                            }))
                                                                        ],
                                                                        is_macro: false
                                                                    })),
                                                                    Normal(Constant(Number(10.0)))
                                                                ],
                                                                is_macro: false
                                                            }))
                                                        ],
                                                        is_macro: false
                                                    })),
                                                    Normal(Constant(Number(11.0)))
                                                ],
                                                is_macro: false
                                            }))
                                        ],
                                        is_macro:false
                                    })),
                                    Normal(Constant(Number(12.0)))
                                ],
                                is_macro:false
                            }))
                        ],
                        is_macro:false
                    })),
                    Normal(Constant(Number(13.0)))
                ],
                is_macro:false
            })
        )]),
        file:["test"],
        line_no:2,
        context: 1
    }
]
